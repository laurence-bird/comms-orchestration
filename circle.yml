machine:
  pre:
    - curl -sSL https://s3.amazonaws.com/circle-downloads/install-circleci-docker.sh | bash -s -- 1.10.0
  services:
    - docker

dependencies:
  # CircleCi will magically install and cache pip dependencies in requirements.txt
  # Cache the resolution-cache and build streams to speed things up
  cache_directories:
    - "~/.sbt"
    - "target/resolution-cache"
    - "project/target/resolution-cache"

test:
  override:
    - sbt test
    - sbt dockerComposeTest

deployment:
  uat_and_prd:
    branch: master
    owner: ovotech
    commands:
      - git clone git@github.com:ovotech/comms-ci-scripts
      - comms-ci-scripts/publish_docker_image.sh
      - comms-ci-scripts/deploy_to_ecs.sh -s orchestration UAT aws/container-definition.json
      - git clone git@github.com:ovotech/comms-e2e-tests && cd comms-e2e-tests && sbt test
      - comms-ci-scripts/deploy_to_ecs.sh -s orchestration PRD aws/container-definition.json
      - comms-ci-scripts/send_librato_deployment_event.sh
      - comms-ci-scripts/comment_on_last_merged_pr.sh

experimental:
  notify:
    branches:
      only:
        - master
